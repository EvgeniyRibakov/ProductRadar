# Саммари алгоритма работы парсера ProductRadar

## Основной поток выполнения (`test_parser_engine.py`)

1. **Инициализация браузера** (Playwright)
2. **Загрузка cookies** (если есть)
3. **Переход на страницу поиска Pipiads**
4. **Авторизация** (если нужно)
5. **Получение товаров со страницы поиска** (`get_products_from_search_page`)
6. **Для каждого товара:**
   - Подключение к Google Sheets
   - Получение деталей товара (`get_product_details`)
   - Запись данных в Google Sheets

---

## Детальный алгоритм обработки товара (`get_product_details`)

### ШАГ 1: Переход на страницу товара
- `page.goto(product_url)`
- Ожидание: `domcontentloaded`

### ШАГ 1.5: Перевод страницы на английский язык
- Замена `/ru/` на `/en/` в URL
- Если не найдено - поиск переключателя языка

### ШАГ 2: Извлечение Product Name
**Страница:** Главная страница товара

**Методы поиска:**
1. Селекторы: `h1`, `h1[class*="product"]`, `[class*="product-title"]`, `[class*="product-name"]`
2. Fallback: JavaScript поиск по всем элементам
3. Фильтрация: убирает служебные тексты ("TikTok Shop Product Detail:", "Category", "Commission Rate")

**Результат:** Название товара или "N/A"

---

### ШАГ 3: Извлечение Category
**Страница:** Главная страница товара

**Методы поиска:**
1. Селекторы: `[class*="category"]`, `text=/Category/i`, `text=/Категория/i`
2. Fallback: JavaScript поиск по всем элементам
3. Очистка: убирает "Category:", "Commission Rate:", лишние символы `>`

**Результат:** Категория в формате "Beauty & Personal Care > Skincare > Skin Care Kits" или "N/A"

---

### ШАГ 3.5: Запись базовых данных в Google Sheets
**Столбцы:**
- **A:** Номер товара (автоматически вычисляется: `row_number - SHEET_START_ROW + 1`)
- **B:** Product Name
- **C:** НЕ ТРОГАТЬ (перевод названия - для другого ИИ)
- **D:** Category
- **E:** Pipiads Link

**Обработка ошибок:**
- Если ячейки защищены → пропуск базовых данных
- Находим пустую строку для записи только видео данных

---

### ШАГ 4: Поиск блока "TikTok Ads"
**Страница:** Главная страница товара (внизу)

**Методы поиска:**
1. Прокрутка страницы вниз (постепенно, как человек)
2. Поиск через Playwright locator: `text=/TikTok Ads/i`, `text=/Реклама ТикТок/i`
3. Fallback 1: JavaScript TreeWalker (поиск по текстовым узлам)
4. Fallback 2: `query_selector` с вариантами текста
5. Fallback 3: Повторная прокрутка и поиск на каждой позиции

**Результат:** Элемент блока "TikTok Ads" или ошибка (остановка обработки)

---

### ШАГ 5: Установка сортировки "First seen"
**Методы:**
1. Поиск dropdown: `select`, `[class*="sort"]`, `text="Sort by"`
2. Если `select` элемент → `select_option(label="First seen")`
3. Если кастомный dropdown → клик → поиск опции `text="First seen"` → клик

**Результат:** Успех или предупреждение (продолжаем без сортировки)

---

### ШАГ 6: Получение списка видео из блока "TikTok Ads"
**Страница:** Главная страница товара (блок TikTok Ads)

**Методы поиска карточек:**
- Селекторы: `[class*="video"]`, `[class*="card"]`, `a[href*="/ad-search/"]`
- Фильтрация: только карточки с play button или thumbnail

**Ограничение:** Обрабатываются только первые 50 карточек (для скорости)

**Извлечение данных из карточки (`_extract_video_data_from_card`):**

1. **Impression:**
   - Regex: `r'Impression[:\s]+([\d.,]+[KM]?)'` (англ.)
   - Regex: `r'Показы[:\s]+([\d.,]+[KM]?)'` (рус.)
   - Fallback: поиск больших чисел (>= 1K) в тексте карточки

2. **First seen:**
   - Regex: `r'First\s+seen[:\s]+([A-Z][a-z]{2}\s+\d{1,2}\s+\d{4})'`
   - Regex: `r'([A-Z][a-z]{2}\s+\d{1,2}\s+\d{4})\s*-\s*[A-Z][a-z]{2}\s+\d{1,2}\s+\d{4}'` (диапазон)
   - Берется первая дата из диапазона

3. **ad_search_url:**
   - Поиск ссылки: `a[href*="/ad-search/"]`
   - Формирование полного URL

**Результат:** Список словарей с данными видео (impression, first_seen, ad_search_url)

---

### ШАГ 7: Фильтрация видео
**Критерии фильтрации:**
- `impression >= 50000` (MIN_IMPRESSIONS)
- Дата `first_seen <= 7 дней` (DAYS_BACK)
- Если даты нет, но `impression >= 50000` → принимаем

**Удаление дубликатов:**
- По `tiktok_link` или `ad_search_url`
- Если оба отсутствуют → по `impression` (не идеально)

**Сортировка:**
1. По дате (самые недавние = больший timestamp, отрицательное для убывания)
2. По impressions (самые большие, отрицательное для убывания)
3. Видео без даты → в конец

**Результат:** Топ-3 уникальных видео

**ПРОБЛЕМА:** В коде установлено `video_count = 1` (строка 764) - обрабатывается только 1 видео вместо 3!

---

### ШАГ 8: Получение детальных метрик для каждого видео
**Переход на страницу ad-search:**

1. Если есть `ad_search_url` → `page.goto(ad_search_url)`
2. Если нет URL → клик на карточку → поиск кнопки "More detail" → клик → ожидание загрузки

**Страница:** Страница ad-search (`/ad-search/<ID>`)

**Извлечение данных (`_extract_ad_search_data`):**

---

## Извлечение данных со страницы ad-search

### 1. TikTok ссылка
**Ключевые слова:** "TikTok Post" (англ.), "Пост TikTok" (рус.)

**Методы:**
1. Поиск локатора: `text=/TikTok Post/i` → поиск ссылки в родительском элементе: `a[href*="tiktok.com"]`
2. Fallback: поиск всех ссылок `a[href*="tiktok.com"]`, берем первую

**Результат:** URL вида `https://m.tiktok.com/v/...` или "N/A"

---

### 2. Impressions
**Ключевые слова:** "Impression" (англ.), "Показ", "Показы" (рус.)

**ВАЖНО:** Искать в разделе "Data/Данные" в пункте "Impression/Показ", НЕ "Likes"!

**Методы:**
1. Поиск раздела "Data" или "Данные": `text=/Data/i`
2. В этом разделе ищем "Impression" или "Показ"
3. Regex: `r'Impression[:\s]*([\d.,]+[KM]?)'`
4. Fallback: прямой поиск "Impression" или "Показ" на странице

**Форматирование:**
- Если уже в формате "170.6K" или "403.2M" → сохраняем как есть
- Если число → конвертируем в формат "170.6K" или "403.2M" через `validator.format_impressions()`

**Результат:** Строка "170.6K", "403.2M" или "N/A"

---

### 3. Script
**Ключевые слова:** "Script" (англ.), "Сценарий" (рус.), "Transcript" (англ.), "Анализ транскрипта" (рус.)

**Методы:**
1. Поиск локатора: `text=/Script/i` или `text=/Сценарий/i`
2. Способ 1: Текст родительского элемента после ключевого слова
3. Способ 2: Текст следующего элемента (nextElementSibling)
4. Fallback: JavaScript поиск по всем элементам

**Очистка:**
- Убирает стоп-слова: "Hook", "Target Audience", "First seen", "Impressions"
- Берет текст до первого стоп-слова

**Результат:** Текст сценария или "N/A"

**ПРОБЛЕМА:** В логах извлекается не настоящий script, а метаданные ("Generator Image Translation...", "Analysis\nHerbal Beauty...")

---

### 4. Hook
**Ключевые слова:** "Hooks" (англ.), "Хуки" (рус.), "Hook" (англ.), "Хук" (рус.)

**Методы:**
1. Поиск локатора: `text=/Hooks/i` или `text=/Хуки/i`
2. Способ 1: Текст родительского элемента после ключевого слова
3. Способ 2: Текст следующего элемента
4. Fallback: JavaScript поиск
5. **Повторный поиск** если не найден (как указано в требованиях)

**Очистка:**
- Убирает стоп-слова: "Target Audience", "First seen", "Transcript", "Impressions"

**Результат:** Текст hook или "N/A"

**ПРОБЛЕМА:** В логах hook не находится (всегда "N/A")

---

### 5. Audience (возраст)
**Ключевые слова:** "Audience" (англ.), "Аудитория" (рус.), "Target Audience" (англ.), "Целевая аудитория" (рус.)

**Формат на странице:** "Аудитория: Возраст: 25-35 | Устройство: Android"

**Методы:**
1. Поиск локатора: `text=/Audience/i` или `text=/Аудитория/i`
2. Regex поиск возраста: `r'Возраст[:\s]+(\d{1,2}-\d{1,2})'` или `r'(\d{1,2}-\d{1,2})'`
3. Fallback: JavaScript поиск по всем элементам

**ВАЖНО:** Записывается только возраст (например "25-35"), без платформы!

**Результат:** Возраст в формате "25-35" или "N/A"

---

### 6. Country
**Ключевые слова:** "Country/Region" (англ.), "Страна/регион" (рус.), "Country" (англ.), "Страна" (рус.)

**ВАЖНО:** Ищется ОТДЕЛЬНО от Audience! Не в поле Target Audience!

**Методы:**
1. Поиск локатора: `text=/Country\/Region/i` или `text=/Страна\/регион/i`
2. Regex поиск страны: список паттернов для разных стран (USA, Philippines, Russia, China, India, и т.д.)
3. Fallback: JavaScript поиск

**Очистка:**
- Убирает `(1)`, `(2)` и т.д. после названия страны

**Результат:** Название страны (например "Philippines") или "N/A"

---

### 7. First seen
**Ключевые слова:** "First seen - Last seen" (англ.), "First seen" (англ.), "Впервые замечено" (рус.)

**Формат на странице:** "Oct 28 2025 ~ Nov 10 2025"

**ВАЖНО:** Извлекается только ПЕРВАЯ дата из диапазона!

**Методы:**
1. Поиск локатора: `text=/First seen/i`
2. Regex: `r'([A-Z][a-z]{2}\s+\d{1,2}\s+\d{4})'` (Oct 27 2025)
3. Берется только до символа `~` (если есть диапазон)
4. Fallback: JavaScript поиск

**Результат:** Дата в формате "Oct 27 2025" или "N/A"

---

## Запись в Google Sheets (`sheets_writer.py`)

### Структура столбцов:

| Столбец | Название | Описание |
|---------|----------|----------|
| A | Номер товара | Автоматически (1, 2, 3...) |
| B | Product Name | Название товара |
| C | Перевод названия | **НЕ ТРОГАТЬ** (для другого ИИ) |
| D | Category | Категория товара |
| E | Pipiads Link | Ссылка на страницу товара |
| F | TikTok Post first video | Ссылка на первое видео |
| G | Impression first video | Количество показов (формат "170.6K" или "403.2M") |
| H | Script first video | Сценарий первого видео |
| I | Hooks first video | Hook первого видео |
| J | Audience first video | Возраст аудитории (формат "25-35", без платформы) |
| K | Country/Region first video | Страна |
| L | First seen first video | Дата (формат "Oct 27 2025") |
| M-S | Видео 2 | То же самое для второго видео |
| T-Z | Видео 3 | То же самое для третьего видео |

### Процесс записи:

1. **Запись базовых данных** (`write_basic_product_data`):
   - Находит пустую строку через `find_next_empty_row()`
   - Записывает: A (номер), B (Product Name), D (Category), E (Pipiads Link)
   - Если ячейки защищены → пропуск, находим пустую строку для видео

2. **Запись данных видео** (`write_product_data`):
   - Использует номер строки из базовых данных
   - Записывает данные для 3 видео (F-Z)
   - Если видео меньше 3 → заполняет "N/A"

3. **Метод записи:**
   - По одной ячейке через `update_acell()`
   - Fallback: `update()` если `update_acell()` не работает
   - Проверка записи: читает значение обратно для подтверждения
   - Задержка 0.1 сек между записями для синхронизации

---

## Проблемы, обнаруженные в логах

### 1. Product Name не находится
**Логи:** `⚠️ Название товара не найдено, будет установлено 'N/A'`
**Причина:** Селекторы не находят заголовок товара на странице
**Нужно:** Улучшить селекторы или добавить более агрессивный JavaScript поиск

### 2. Обрабатывается только 1 видео вместо 3
**Код:** `video_count = 1  # Для MVP-0` (строка 764 в `parser_engine.py`)
**Нужно:** Изменить на `video_count = 3`

### 3. Impression записывается как число
**Логи:** `G8: 403200000` вместо `403.2M`
**Причина:** В некоторых случаях форматирование не применяется
**Нужно:** Проверить логику форматирования в `_extract_impressions()` и `sheets_writer.py`

### 4. Script извлекается неправильно
**Логи:** "Generator Image Translation..." и "Analysis\nHerbal Beauty..."
**Причина:** Извлекаются метаданные вместо настоящего сценария
**Нужно:** Улучшить поиск и очистку script, возможно искать в другом месте на странице

### 5. Hook не находится
**Логи:** `⚠️ Hook не найден после повторного поиска, установлено 'N/A'`
**Причина:** Селекторы не находят поле Hook на странице
**Нужно:** Улучшить поиск hook, возможно он находится в другом месте или имеет другое название

### 6. Audience записывается с платформой
**Логи:** "25-35 Android" вместо "25-35"
**Причина:** В коде записывается и возраст, и платформа
**Нужно:** В `sheets_writer.py` записывать только возраст (уже исправлено в коде, но нужно проверить)

---

## Как код ищет данные на страницах

### На главной странице товара (`/tiktok-shop-product/<ID>`):

1. **Product Name:**
   - Селекторы: `h1`, `h1[class*="product"]`, `[class*="product-title"]`
   - JavaScript: поиск по всем элементам, фильтрация служебных текстов

2. **Category:**
   - Селекторы: `[class*="category"]`, `text=/Category/i`
   - JavaScript: поиск текста с "Category:" или "Категория:"

3. **Блок TikTok Ads:**
   - Прокрутка вниз → поиск `text=/TikTok Ads/i`
   - Fallback: JavaScript TreeWalker

4. **Карточки видео:**
   - Селекторы: `[class*="video"]`, `a[href*="/ad-search/"]`
   - Фильтрация: только карточки с play button или thumbnail

5. **Impression из карточки:**
   - Regex: `r'Impression[:\s]+([\d.,]+[KM]?)'`
   - Fallback: поиск больших чисел в тексте

6. **First seen из карточки:**
   - Regex: `r'([A-Z][a-z]{2}\s+\d{1,2}\s+\d{4})'`
   - Берется первая дата из диапазона

### На странице ad-search (`/ad-search/<ID>`):

1. **TikTok ссылка:**
   - Поиск `text=/TikTok Post/i` → ссылка в родительском элементе
   - Fallback: все ссылки `a[href*="tiktok.com"]`

2. **Impressions:**
   - Раздел "Data/Данные" → "Impression/Показ"
   - Regex: `r'Impression[:\s]*([\d.,]+[KM]?)'`

3. **Script:**
   - Поиск `text=/Script/i` или `text=/Сценарий/i`
   - Текст родительского элемента или следующего элемента
   - Очистка от стоп-слов

4. **Hook:**
   - Поиск `text=/Hooks/i` или `text=/Хуки/i`
   - Текст родительского элемента или следующего элемента
   - Повторный поиск если не найден

5. **Audience:**
   - Поиск `text=/Audience/i` или `text=/Аудитория/i`
   - Regex: `r'(\d{1,2}-\d{1,2})'` для возраста
   - Записывается только возраст, без платформы

6. **Country:**
   - Поиск `text=/Country\/Region/i` или `text=/Страна\/регион/i`
   - Regex: список паттернов для разных стран
   - ОТДЕЛЬНО от Audience!

7. **First seen:**
   - Поиск `text=/First seen/i`
   - Regex: `r'([A-Z][a-z]{2}\s+\d{1,2}\s+\d{4})'`
   - Берется только первая дата из диапазона (до `~`)

---

## Общая стратегия поиска данных

Все методы используют **многоуровневый fallback**:

1. **Уровень 1:** Playwright селекторы (быстро, надежно)
2. **Уровень 2:** JavaScript поиск по всем элементам (медленно, но агрессивно)
3. **Уровень 3:** Regex поиск в тексте страницы (если структура нестандартная)

**Поддержка локализации:**
- Все ключевые слова ищутся на английском И русском
- Приоритет английскому, fallback на русский

**Обработка ошибок:**
- Если данные не найдены → "N/A"
- Если ячейки защищены → пропуск, поиск новой строки
- Логирование всех попыток поиска для отладки

